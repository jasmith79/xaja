import extractType from'../../../node_modules/extracttype/extracttype.js';const global=new Function('return this;')(),{Promise,encodeURIComponent,btoa,fetch,localStorage,Error,Object,Request}=global,base64Encode=(a)=>{let b=encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,(a,b)=>String.fromCharCode('0x'+b));return btoa(b)},extractUserAndPass=(a)=>{if(a){const[{user:c,pass:d},b]=Object.entries(a).reduce(([a,b],[c,d])=>(c.match(/user/i)?a.user=d:c.match(/pass/i)?a.pass=d:b[c]=d,[a,b]),[{},{}]);return c&&d?[`Basic ${base64Encode(c+':'+d)}`,b]:[{},b]}return null};export const toURLString=(a)=>{switch(extractType(a)){case'Null':case'Undefined':return'';case'String':return encodeURIComponent(a);default:return Object.entries(a).map(([a,b])=>`${encodeURIComponent(a)}=${encodeURIComponent(b)}`).join('&');}};export const fetchLoaded=new Promise((a,b)=>{if(!fetch){const c=document.createElement('script');c.src='./node_modules/whatwg-fetch/fetch.js',c.onload=()=>{a([global.fetch,global.Request])},c.onerror=(a)=>{b(a)},global.document.head.appendChild(c)}else a([global.fetch,global.Request])});export const request=(a)=>{let{url:c,data:d,method:h='GET',responseType:b,contentType:e,timeout:i=0,cache:f,headers:g,credentials:j='same-origin'}=a;if(!c)if('String'===extractType(a))c=a;else return Promise.reject(new TypeError('HTTP request must include a url.'));if(!b){let a=c.match(/\.(html|json|text|txt)$/);b=a?'txt'===a[1]?'text':a[1]:'text'}let k,l;if(d)switch(extractType(d)){case'String':e=e||'text/plain;charset=UTF-8',l=d;break;case'FormData':l=d;break;case'Object':let[f,a]=extractUserAndPass(d);k=f,'GET'===h.toUpperCase()?(c=`${c}?${toURLString(a)}`,e=e||'application/x-www-form-urlencoded;charset=UTF-8'):(l=new FormData,Object.entries(a).forEach(([a,b])=>{l.append(a,b)}));break;default:l=d;}const m=g||new Headers;k&&!m.get('Authorization')&&m.set('Authorization',k),e&&!m.get('Content-Type')&&m.set('Content-Type',e);const n={method:h,headers:m,credentials:j};'GET'!==h.toUpperCase()&&(n.body=l),'POST'!==h.toUpperCase()||n.body||(n.body={});let o=new Request(c,n);const q=fetchLoaded.then(([a,b])=>new Promise((b,d)=>{let e=a(o).then((a)=>{if(200<=a.status&&300>a.status)return a;else{const b=new Error(a.statusText);b.response=a;const d=localStorage.getItem(c);if(d){console.warn(b.message+' resolving with cached data...');const a=()=>Promise.resolve(d);return{json:a,text:a,blob:a,arrayBuffer:a}}throw b}});if(i){const a=setTimeout(()=>{const a=`Request for ${c} reached timeout of ${i}ms.`,e=localStorage.getItem(c);if(e){console.warn(a+' resolving with cached data...');const c=()=>Promise.resolve(e);b({json:c,text:c,blob:c,arrayBuffer:c})}else d(new Error(a))},i);e.then((c)=>{global.clearTimeout(a),b(c)})}else b(e)}));q.request=o;const p=b.toLowerCase();let r;switch(p){case'text':case'html':return r=q.then((a)=>a.text()).then((a)=>(f&&'GET'===h.toUpperCase()&&localStorage.setItem(c,a),a)),Object.defineProperty(r,'request',{get:()=>q.request}),r;case'json':return r=q.then((a)=>a.json()).then((a)=>(f&&'GET'===h.toUpperCase()&&localStorage.setItem(c,a),a)),Object.defineProperty(r,'request',{get:()=>q.request}),r;case'blob':case'arrayBuffer':return Object.defineProperty(r,'request',{get:()=>q.request}),q.then((a)=>a[p]());case'stream':default:return q;}};export const get=(a,b,c={})=>{const d=Object.entries(c).reduce((a,[b,c])=>(a[b]=c,a),{});return d.method='GET',d.url=a,b&&(d.data=b),request(d)};export const getJSON=(a,b,c={})=>{const d=Object.entries(c).reduce((a,[b,c])=>(a[b]=c,a),{});return d.method='GET',d.url=a,d.responseType='json',b&&(d.data=b),request(d)};export const post=(a,b,c={})=>{const d=Object.entries(c).reduce((a,[b,c])=>(a[b]=c,a),{});return d.method='POST',d.url=a,b&&(d.data=b),request(d)};export default request;